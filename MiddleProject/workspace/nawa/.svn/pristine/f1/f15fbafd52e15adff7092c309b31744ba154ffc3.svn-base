package board.controller;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import atch.service.BoardAtchFileServiceImpl;
import atch.service.IBoardAtchFileService;
import atch.vo.BoardAtchFileVO;
import board.service.CommentServiceImpl;
import board.service.ICommentService;
import board.service.IPostService;
import board.service.PostServiceImpl;
import board.vo.PostVO;

@WebServlet("/board/detail.do")
public class DetailController extends HttpServlet {
	
	@Override
	protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
		
		int postNo = Integer.parseInt(req.getParameter("postNo")); //key값=id
		
		IPostService postService = PostServiceImpl.getInstance();
		
		// 먼저 조회수 업데이트
	    postService.updateViewCnt(postNo);

	    // 게시물 조회
	    PostVO pv = postService.getPostNo(postNo);
		
		req.setAttribute("pv", pv);
		
		BoardAtchFileVO bv = new BoardAtchFileVO();
		if(bv.getBoardFIndex() > 0) { // 첨부파일이 존재하는 경우...
			
			BoardAtchFileVO BoardAtchFileVO = new BoardAtchFileVO();
			IBoardAtchFileService fileService = BoardAtchFileServiceImpl.getInstance();
			
			BoardAtchFileVO.setBoardFIndex(bv.getBoardFIndex());
			
			List<BoardAtchFileVO> boardAtchFileList = 
					fileService.getBoardAtchFileList(BoardAtchFileVO);
			
			req.setAttribute("boardAtchFileList", boardAtchFileList);
		}

		//댓글 표시 시작########################################		
		
		ICommentService commService = CommentServiceImpl.getInstance();
		
		String commPageStr = req.getParameter("commPage");
        int commPage = (commPageStr != null && !commPageStr.isEmpty()) ? Integer.parseInt(commPageStr) : 1;
        int commCountPerPage = 10; // 페이지당 댓글 수 조절 ########################
        
        int commStart = (commPage - 1) * commCountPerPage + 1;
        int commEnd = commPage*commCountPerPage;
        
        pv.setCommStart(commStart);
        pv.setCommEnd(commEnd);
        
        List<PostVO> commList = commService.getCommentListWithPaging(pv);

        int totalCommCount = commService.getTotalCommentCount(postNo);
        int totalCommPages = (int) Math.ceil((double) totalCommCount / commCountPerPage);

        // 현재 페이지와 전체 페이지 수 전달
        req.setAttribute("totalCommPages", totalCommPages);
        req.setAttribute("currentCommPage", commPage);
        
        req.setAttribute("commList", commList);
        req.getRequestDispatcher("/board/board/detail.jsp").forward(req, resp);
	}
	
	@Override
	protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
//		doGet(req, resp);
		
		resp.setContentType("text/html;charset=UTF-8");
	    req.setCharacterEncoding("UTF-8");
		
	    int postNo = Integer.parseInt(req.getParameter("postNo"));
	    String commWriter = req.getParameter("commWriter");
	    String commContent = req.getParameter("commContent");

	    ICommentService commService = CommentServiceImpl.getInstance();
		
		PostVO pv = new PostVO();
        pv.setPostNo(postNo);
        pv.setCommWriter(commWriter);
        pv.setCommContent(commContent);
        
		int cnt = commService.insertComment(pv);
		
		String msg = "";
		if(cnt > 0) {
			msg = "성공";
		}else {
			msg = "실패";
		}
		
		req.getSession().setAttribute("msg", msg);
		
		req.setAttribute("postNo", postNo);
		req.setAttribute("commWriter", commWriter);
		req.setAttribute("commContent", commContent);
		
		resp.sendRedirect(req.getContextPath() + "/board/detail.do" + "?postNo=" + postNo );
		
	}
}
