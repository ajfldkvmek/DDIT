<%@page import="java.util.List"%>
<%@page import="atch.vo.BoardAtchFileVO"%>
<%@page import="board.vo.PostVO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%
	PostVO pv =(PostVO)request.getAttribute("pv");

	List<BoardAtchFileVO> atchFileList = (List<BoardAtchFileVO>) request.getAttribute("boardAtchFileList"); 
	List<PostVO> commList = (List<PostVO>) request.getAttribute("commList");
	List<PostVO> postList = (List<PostVO>)request.getAttribute("postList");

	String msg = session.getAttribute("msg") == null ? "" 
		: (String) session.getAttribute("msg");
	session.removeAttribute("msg");

	System.out.println("[detail.jsp] pv: " + pv);
	System.out.println("[detail.jsp] postNo: " + pv.getPostNo());
	System.out.println("[detail.jsp] commList: " + commList);
	System.out.println("[detail.jsp] postList: " + postList);
%>

<%@include file="/include/header.jsp"%>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<style>
#detailContainer {
padding: 10px;
}
#buttonContainer, #commnetInsertContainer, #contContainer, #commentsContainer {
padding: 10px;
width: 100%;
}
.detailCate{
text-align: center;
}
#commInsertWriter, #commInsertCont {
padding: 2px;
margin: 2px;
}
#commentInsertContainer, #commentInsertForm {
  display: flex;
/*   justify-content: center; */
}

</style>




<div id="detailContainer" class="col-sm-12 text-left">
	<div class="table-responsive" id="contContainer">  
	<table width=100% class="table table-striped">

		<tr>
			<th class="detailCate" width=15%>제목</th>
			<td class="detailCate" colspan="5"><%=pv.getPostTitle()%></td>
		</tr>
		<tr>
			<th class="detailCate" width=15%>작성자</th>
			<td colspan="1"><%=pv.getPostWriter()%></td>
			
			<th class="detailCate" width=15%>등록일</th>
<%-- 			<td class="detailCate" width=15% colspan="2"><%=pv.getPostDate() %> --%>
			<td class="detailCate" colspan="1"><%=pv.getPostDate()%>
			<th class="detailCate" width=15%>조회수</th>
			<td class="detailCate" colspan="1"><%=pv.getViewCnt()%></td>
		</tr>
		<tr>
			<th class="detailCate" width=15%>내용</th>
			<td colspan="5"><%=pv.getPostContent()%></td>
		</tr>
		<tr>
			<th class="detailCate">첨부파일</th>
			<td colspan="5">
				<%
					if(atchFileList != null) { 
											for(BoardAtchFileVO fileVO : atchFileList) {
				%>
					<div>
						<a href="<%=request.getContextPath()%>/fileDownload.do?fileId=<%=fileVO.getBoardFIndex()%>">
						<%=fileVO.getBoardOriName()%>
						</a>
					</div>
					<%
						}
										}
					%>
			</td>
		</tr>
	</table>
	</div>

	<div id="buttonContainer">
			<button type="button" class="btn btn-dark" onclick="location.href='./list.do'">목록</button>
			<button type="submit" class="btn btn-dark" onclick="location.href='./update.do?postNo=${pv.getPostNo()}'">수정</button>
			<button type="submit" class="btn btn-danger" onclick="location.href='./delete.do?postNo=${pv.getPostNo()}'">삭제</button>
	</div>


	<div id="commnetInsertContainer" class="form-group">
		<form action="./commInsert.do" method="post" enctype="multipart/form-data" id="commentInsertForm">
			<input type="hidden" name="postNo" value="<%=pv.getPostNo()%>">
				<label for="commWriter" id="commInsertWriter">작성자: </label>
				<input type="text" class="form-control" id="commWriter" name="commWriter">
				
				<label for="commContent" id="commInsertCont">내용: </label>
				<textarea class="form-control" id="commContent" name="commContent" 
					maxlength="1000" 
					placeholder="본문을 쓰세요."></textarea>
				
				<button type="submit" class="btn btn-success" >댓글 남기기</button>
		</form>
	</div>


	<div id="commentsContainer">
	<table width=100% class="table table-striped">
				<%
					if(commList.size() == 0 ) {
				%>
				<tr>
					<td colspan="6">댓글이 없습니다.</td>

				</tr>
				<%
					}else{
				%>
				<tr>
					<th>작성자</th>
					<th>내용</th>
					<th>작성일</th>
					<th></th>
				</tr>
				
				<%
									for(PostVO pv2 : commList) {
								%>
				<tr>
					<td id="commWriter"><%=pv2.getCommWriter() %></td>
					<td id="commContent"><%=pv2.getCommContent() %></td>
					<td id="commDate"><%=pv2.getCommDate() %></td>
					<td>
					<button type="submit" class="btn btn-dark btn-sm" onclick="location.href='./commUpdate.do?postNo=<%=pv2.getPostNo()%>&commNo=<%=pv2.getCommNo()%>'">수정</button>
					<button type="submit" class="btn btn-danger btn-sm" onclick="location.href='./commDelete.do?postNo=<%=pv2.getPostNo()%>&commNo=<%=pv2.getCommNo()%>'">삭제</button>
					</td>
				</tr>
					<%
					}
				}
				%>
	</table>
</div>


<!-- 페이징 처리된 댓글 목록 시작 -->
<div id="commPagination">
    <%
    Integer currentCommPageObj = (Integer) request.getAttribute("currentCommPage");
    Integer totalCommPagesObj = (Integer) request.getAttribute("totalCommPages");

    int currentCommPage = (currentCommPageObj != null) ? currentCommPageObj : 1;
    int totalCommPages = (totalCommPagesObj != null) ? totalCommPagesObj : 1;

    int maxCommPagesToShow = 5; // 보여줄 최대 페이지 수

    int startCommPage = Math.max(1, currentCommPage - maxCommPagesToShow / 2);
    int endCommPage = Math.min(startCommPage + maxCommPagesToShow - 1, totalCommPages);
    
//     System.out.println("[detail.jsp] currentCommPage: " + currentCommPage);
//     System.out.println("[detail.jsp] totalCommPages: " + totalCommPages);
//     System.out.println("[detail.jsp] startCommPage: " + startCommPage);
//     System.out.println("[detail.jsp] endCommPage: " + endCommPage);
    		
    %>
</div>

	    <!-- '이전' 버튼 -->
    <div class="container text-center col-sm-12">
    	<ul class="pagination justify-content-center">
	<%
		if(currentCommPage > 1) {
	%>
			<li class="page-item">
			<a href="./detail.do?postNo=<%= pv.getPostNo() %>&commPage=<%= currentCommPage - 1 %>" class="page-link">이전</a>
			</li>
	<%
		}else{
	%>
	<%
		}
	%> 
	

	<!-- 페이지 목록 -->
	<%
	if (startCommPage > 1) {
	%>
		<li class="page-item">
		<a href="./detail.do?postNo=<%= pv.getPostNo() %>commPage=1" 
			class="page-link">1</a>
		</li>
		<li class="page-item">
		<span class="ellipsis">...</span>
		</li>
	<%
	}

	for (int i = startCommPage; i <= endCommPage; i++) {
		if (i == currentCommPage) {
	%>
			<li class="page-item active">
			<a class="page-link" href="#">
			<span class="current-page">
			<%= i %>
			</span>
			</a>
			</li>
	<%
		} else {
	%>
			<li class="page-item">
			<a href="./detail.do?postNo=<%=pv.getPostNo() %>&commPage=<%= i %>" class="page-link"><%= i %></a>
			</li>
	<%
		}
	}

	if (endCommPage < totalCommPages) {
	%>
		<li class="page-item">
			<span class="ellipsis">...</span>
		</li>
		<li class="page-item">
			<a href="./detail.do?postNo=<%= pv.getPostNo() %>&commPage=<%= totalCommPages %>" class="page-link"> <%= totalCommPages %></a>
		</li>
	<%
	}
	%>
	<!-- 페이지 목록 끝 -->
	
	
    <!-- '다음' 버튼 -->
		<%
		if(currentCommPage < totalCommPages) {
		%>
			<li class="page-item">
				<a href="./detail.do?postNo=<%=pv.getPostNo() %>&commPage=<%= currentCommPage + 1 %>" class="page-link">다음</a>
			</li>
		<%
		}else{
		%>
				
		<%
		}
		%>    	 
	<!-- '다음' 버튼 끝 -->
	</ul>
</div>
	


	
</div>	
			
<script>

</script>

<%@include file="/include/footer.jsp"%>

</body>
</html>